# Telegram

Позволяет автоматически отправлять, а также получать сообщения и медиафайлы в чатах и каналах Telegram прямо из бизнес-процессов Bpium. Это идеальный инструмент для мгновенных уведомлений о новых заявках, изменениях статусов или для отправки ежедневных отчетов. Позволяется отправка, как с личных аккаунтов так и посредством ботов полученных от BotFather телеграма.

## Свойства

### Секция «Подключение»

Перед использованием компонента его необходимо авторизовать.

* Авторизационный токен (обязательное) — это ключ доступа вашего аккаунта/бота. Чтобы получить токен ознакомьтесь с правилами работы сервиса токенов Bpium.
* Тип подключения (обязательное) — определяет контекст, от имени кого будет отправлено сообщение. Доступные варианты: Пользователь, Бот.

### Секция «Параметры»

* **Действие**  — Выберите действие, которое должен выполнить компонент. На данный момент доступны следующие действия ”Отправить сообщение, Отправить геолокацию, Отправить контакт, Переслать сообщение, Изменить сообщение, Удалить сообщение, Получить диалоги, Получить профиль, Получить сообщения”.
* **Диалог** — Уникальный идентификатор чата, куда будет отправлено/получено сообщение. Это может быть @username пользователя или публичного канала, либо числовой chat\_id группового чата или личного диалога, а также номер телефона в формате "+79991234567".
* **Текст**  — Текстовая часть отправляемого сообщения. Вы можете использовать статический текст или динамические данные, подставляя значения через выражения и переменные из процесса (например, `allValues.message`).
* **Формат текста** — Позволяет выбрать разметку для текста. Доступные варианты: Markdown или HTML. Используйте этот параметр, чтобы добавить в сообщение жирный шрифт, курсив, списки или ссылки.
* **Вложения** — Позволяет прикрепить к сообщению файлы (изображения, документы, видео и т.д.). Для загрузки файла укажите выражение, которое возвращает его fileId (Формат: массив объектов вида `[ { title: "...", url: "https://..." }, ... ]`).
* **Формат отправки вложений** — Медиа - отправить сжатые файлы. Документы - отправить файлы без сжатия. (Недоступно для  бота)
* **Ответить на сообщение** — Позволяет отправить сообщение, как ответ на конкретное сообщение в чате. Для этого укажите message\_id сообщения, на которое нужно ответить.
* **ID сообщения** — Дополнительное поле, заполняется при выборе опции Ответить на сообщение.
* **Отправить позже** — Отложенная отправка сообщения
* **Дата отправки** — Дополнительное поле, заполняется при выборе опции Отправить позже. Формат: дата в формате ISO, timestamp (мс), объект Date или moment.
* **Отправить без уведомления** — Если эта опция активна, сообщение будет отправлено «бесшумно». Пользователи в чате не получат звукового уведомления или push.
* **Кнопки** — параметр доступен только для рассылки ботами

Объект вида:&#x20;

* Inline-клавиатура: `{"inline_keyboard": [[{ "text": "Открыть сайт", "url": "https://example.com" }]]}`;
* Reply-клавиатура: `{"keyboard": [[{ "text": "Привет" }, { "text": "Локация", "request_location": true }]], "resize": true }`;
* Удалить клавиатуру: `{"remove_keyboard": true}`.

### Секция «Результат»

Результат работы компонента можно сохранить в переменную процесса для дальнейшего использования в логике.

* **Сохранить результат в** —  Укажите имя переменной, в которую будет записан ответ от сервера Telegram.&#x20;

В эту переменную сохранится объект с данными отправленного сообщения (например, его уникальный message\_id). Это полезно, если вы планируете позже редактировать это сообщение или отвечать на него в рамках этого же процесса.

## Получение авторизационного токена

Для получения токена понадобится API ID и API Hash от Telegram.

### Получение API ID и API Hash

Чтобы получить API ID и API Hash перейдите по адресу [https://my.telegram.org/auth](https://my.telegram.org/auth) и войдите с помощью номера телефона, который хотите привязать в качестве отправителя.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Перейдите в API development tools и создайте новое приложение, заполнив поля:

* **App title:** придумайте и введите полное название своего приложения, которое регистрируется для получения доступа к инструментам разработчика в Telegram.
* **Short name:** придумайте и введите короткое название своего приложения.
* **URL:** введите ссылку сайта Бипиум `https://bpium.ru`
* **Platform:** выберите операционную систему приложения. По умолчанию можно выбрать `Desktop`
* **Description:** заполните поле описания (обязательный шаг)

Нажмите `Create application`  чтобы получить поля конфигурации API (App api\_id, App api\_hash).    &#x20;

<figure><img src="../../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>



<figure><img src="../../../../.gitbook/assets/image (237).png" alt=""><figcaption><p>Автоматизации: сервис получения токенов. Заполнение полей конфигурации API</p></figcaption></figure>

### Получение токена&#x20;

Откройте [tokens.bpium.ru](https://tokens.bpium.ru/) и выберите сервис telegram.&#x20;

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

В открывшемся окне введите ранее полученные  `API ID` и `API Hash`, а также Номер телефона, который был использован при получении  `API ID` и `API Hash`.

<figure><img src="../../../../.gitbook/assets/image (19) (1).png" alt=""><figcaption><p>Автоматизации: сервис получения токенов</p></figcaption></figure>

После подтверждения авторизации на 3 шаге вы получите ключ, который необходимо скопировать. Этот ключ и есть необходимый вам токен.

<figure><img src="../../../../.gitbook/assets/image (239).png" alt=""><figcaption><p>Автоматизации: сервис получения токенов</p></figcaption></figure>

Вернитесь в систему Бипиум, в раздел Управление и там в каталоге "Доступы к сервисам" создайте запись с полученным токеном, который будет использовать компонент Telegram.&#x20;

## Пограничные события

![](../../../../.gitbook/assets/boundary_any.png)

Компонент поддерживает 2 типа пограничных событий:

* Ошибка — выход из компонента, если произошла какая-либо ошибка
* Таймаут — выход из компонента, спустя заданное ограничение по времени

Если компонент завершился с ошибкой, но на нем не было пограничного события, то процесс завершается. Сообщение ошибки возвращается в результатах процесса.

## Вариант использования

### Уведомление клиента о статусе заказа

Цель: При изменении статуса заказа на «Готов к выдаче» отправить уведомление клиенту в «Telegram».

Создайте сценарий, инициируемый изменением статуса в каталоге «Заказы».

1. Добавьте компонент «Telegram» в холст процесса.
2. Настройте подключение: в поле Авторизационный токен выберите заранее настроенное подключение к Telegram API.
3. Заполните параметры:

*  Действие: Отправить сообщение.
* Диалог: allValues.phone (номер телефона клиента из записи)
* Текст: "Уважаемый клиент! Ваш заказ № ${allValues.goods}, готов к выдаче. Ждем вас по адресу: г. Казань, ул. Примерная, д. 1".

4. Сохраните сценарий.

Теперь при смене статуса заказа клиент будет автоматически получать уведомление в Telegram с актуальной информацией о его заказе.

