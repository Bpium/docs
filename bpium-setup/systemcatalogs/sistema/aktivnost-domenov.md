# Активность доменов

## Введение

Системный каталог **Активность доменов** содержит статистику выполнения запросов для каждой компании в системе Бипиум. Каждая запись в каталоге представляет собой агрегированную статистику запросов к домену компании за определенный период времени.

Каталог **Активность доменов** доступен администраторам серверной версии Бипиум и позволяет анализировать нагрузку на систему, производительность запросов и активность доменов.

> **Важно:** Записи в каталоге создаются автоматически системой. Не рекомендуется создавать, редактировать или удалять записи вручную, так как это может привести к искажению статистики.

## Назначение каталога

Каталог **Активность доменов** используется для:

* **Мониторинга нагрузки**: отслеживание количества запросов к каждому домену компании
* **Анализа производительности**: анализ времени выполнения запросов (общее и среднее время)
* **Статистики активности**: определение наиболее активных доменов и периодов пиковой нагрузки
* **Оптимизации системы**: выявление доменов с высокой нагрузкой для оптимизации производительности

## Доступ к каталогу

Каталог **Активность доменов** находится в разделе **Система** и доступен только администраторам сервера Бипиум.

**Как открыть каталог:**

1. Войдите в систему с правами администратора
2. Перейдите в раздел **Система** (в главном меню)
3. Выберите каталог **Активность доменов**

## Поля каталога

Поля в каталоге отображаются в следующем порядке:

| Поле                      | Тип   | Описание                                                                                 |
| ------------------------- | ----- | ---------------------------------------------------------------------------------------- |
| **Дата интервала**        | Дата  | Дата и время начала периода статистики. Показывает, за какой период собрана статистика   |
| **Домен**                 | Связь | Связь с компанией (доменом). Позволяет определить, для какой компании собрана статистика |
| **Число запросов**        | Число | Количество запросов, выполненных к домену за указанный период                            |
| **Общее время запросов**  | Число | Суммарное время выполнения всех запросов за период (в секундах)                          |
| **Среднее время запроса** | Число | Среднее время выполнения одного запроса (в миллисекундах)                                |

## Как работает сбор статистики

### Автоматическое создание записей

Записи в каталоге **Активность доменов** создаются автоматически системой при выполнении запросов пользователей:

1. **При каждом запросе пользователя** система определяет компанию по домену запроса
2. **Система накапливает статистику** в памяти (количество запросов, суммарное время выполнения)
3. **Периодически создаются записи** в каталоге с агрегированной статистикой за период

### Период создания записей

Период создания записей статистики настраивается через переменную окружения `ACTIVITY_REQUEST_PERIOD` в файле `config.env`.

**Настройка:**

```env
ACTIVITY_REQUEST_PERIOD=3600000
```

Где `ACTIVITY_REQUEST_PERIOD` — минимальный интервал между созданиями записей статистики в миллисекундах.

**Примеры:**

* `3600000` (1 час = 3600000 мс) — записи создаются не чаще, чем раз в час (при наличии запросов)
* `1800000` (30 минут) — записи создаются не чаще, чем раз в 30 минут (при наличии запросов)
* `7200000` (2 часа) — записи создаются не чаще, чем раз в 2 часа (при наличии запросов)

> **Важно:**
>
> * Записи создаются **только при наличии запросов** к системе. Если запросов нет, записи не создаются, даже если прошел период `ACTIVITY_REQUEST_PERIOD`.
> * `ACTIVITY_REQUEST_PERIOD` определяет **минимальный интервал** между созданиями записей, а не гарантирует создание записи каждые N миллисекунд.
> * Если `ACTIVITY_REQUEST_PERIOD` не установлен или равен `0`, сбор статистики запросов отключен, и записи в каталоге не создаются.

### Оптимизация производительности

Система использует механизм throttling (ограничение частоты) для оптимизации создания записей:

* Статистика накапливается в памяти между созданиями записей
* Записи создаются не чаще, чем раз в период, указанный в `ACTIVITY_REQUEST_PERIOD`
* При завершении процесса сервера все накопленные данные сохраняются в каталог

## Практические сценарии

### Анализ нагрузки на домен

**Задача:** Определить, какая нагрузка приходится на конкретный домен компании.

**Решение:**

1. Откройте каталог **Активность доменов**
2. Используйте фильтр по полю **Домен** для выбора нужной компании
3. Отсортируйте записи по полю **Дата интервала** (по убыванию) для просмотра последних периодов
4. Проанализируйте поля:
   * **Число запросов** — показывает количество запросов за период
   * **Общее время запросов** — показывает общую нагрузку на систему
   * **Среднее время запроса** — показывает производительность системы

**Анализ:**

* Высокое значение **Число запросов** указывает на активное использование домена
* Высокое значение **Среднее время запроса** может указывать на проблемы с производительностью
* Сравнение значений за разные периоды позволяет выявить тренды нагрузки

### Определение пиковых периодов нагрузки

**Задача:** Найти периоды, когда нагрузка на систему была максимальной.

**Решение:**

1. Откройте каталог **Активность доменов**
2. Отсортируйте записи по полю **Число запросов** (по убыванию)
3. Просмотрите записи с наибольшим количеством запросов
4. Обратите внимание на поле **Дата интервала** для определения времени пиковой нагрузки

**Применение:**

* Планирование обслуживания системы в периоды низкой нагрузки
* Масштабирование ресурсов перед ожидаемыми пиками нагрузки
* Анализ причин высокой нагрузки в определенные периоды

### Сравнение производительности доменов

**Задача:** Сравнить производительность запросов для разных доменов.

**Решение:**

1. Откройте каталог **Активность доменов**
2. Используйте группировку по полю **Домен**
3. Сравните значения поля **Среднее время запроса** для разных доменов
4. Обратите внимание на домены с высоким средним временем запроса

**Анализ:**

* Домены с высоким **Средним временем запроса** могут требовать оптимизации
* Сравнение **Общего времени запросов** показывает общую нагрузку на каждый домен
* Выявление доменов с необычно высокой нагрузкой может указывать на проблемы

### Настройка сбора статистики

**Задача:** Настроить систему для регулярного сбора статистики запросов.

**Решение:**

1. Откройте файл `config.env` на сервере
2. Добавьте или измените параметр:

```env
# Статистика запросов
ACTIVITY_REQUEST_PERIOD=3600000         # Статистика каждый час
```

3. Перезапустите сервер Бипиум для применения изменений

**Рекомендации по настройке:**

* **Для активных систем**: Используйте меньшие значения периодов (например, `1800000` для обновления каждые 30 минут) для более детальной статистики
* **Для систем с высокой нагрузкой**: Используйте большие значения периодов (например, `7200000` для обновления каждые 2 часа) для снижения нагрузки на базу данных
* **Для отключения статистики**: Удалите или закомментируйте переменную `ACTIVITY_REQUEST_PERIOD` или установите значение `0`

## Важная информация

### Автоматическое создание записей

> **Важно:** Записи в каталоге **Активность доменов** создаются автоматически системой. Не рекомендуется:

* Создавать записи вручную — это может привести к дублированию или искажению статистики
* Редактировать существующие записи — это может нарушить целостность статистики
* Удалять записи без необходимости — это может привести к потере исторических данных

### История изменений

> **Примечание:** История каталога **Активность доменов** отключена для оптимизации производительности. Изменения в записях статистики не сохраняются в истории. Это нормальное поведение, так как записи создаются автоматически системой и не требуют отслеживания изменений.

### Хранение данных

Статистика запросов накапливается в памяти сервера и периодически сохраняется в каталог. При завершении процесса сервера (нормальном или аварийном) все накопленные данные автоматически сохраняются в каталог перед завершением работы.

### Производительность

Сбор статистики запросов оптимизирован для минимизации влияния на производительность системы:

* Используется механизм throttling для ограничения частоты создания записей
* Статистика накапливается в памяти между сохранениями
* Записи создаются асинхронно, не блокируя выполнение запросов пользователей

## Часто задаваемые вопросы

### Почему в каталоге нет записей или записи создаются с большими промежутками?

Возможные причины:

1. **Статистика отключена**: Проверьте, установлена ли переменная `ACTIVITY_REQUEST_PERIOD` в `config.env` и не равна ли она `0`
2. **Нет активности пользователей**: Если пользователи не выполняют запросы к системе, статистика не собирается. Записи создаются только при наличии запросов
3. **Сервер был выключен**: Если сервер был выключен, записи не создавались в этот период. После включения статистика начнет собираться заново
4. **Низкая активность**: Если запросов мало или они происходят редко, промежутки между записями могут быть большими

**Решение:** Проверьте настройки в `config.env` и убедитесь, что есть активность пользователей. Помните, что записи создаются только при наличии запросов, а не автоматически каждые N миллисекунд.

### Можно ли изменить период сбора статистики?

Да, период сбора статистики настраивается через переменную окружения `ACTIVITY_REQUEST_PERIOD` в файле `config.env`. После изменения значения необходимо перезапустить сервер Бипиум.

**Примеры периодов:**

* `1800000` — каждые 30 минут
* `3600000` — каждый час (рекомендуется)
* `7200000` — каждые 2 часа

### Влияет ли сбор статистики на производительность?

Сбор статистики оптимизирован и не должен существенно влиять на производительность:

* Статистика накапливается в памяти
* Записи создаются асинхронно
* Используется механизм throttling для ограничения частоты создания записей

Однако при очень большом количестве компаний и высокой нагрузке рекомендуется увеличить значение `ACTIVITY_REQUEST_PERIOD` для снижения нагрузки на базу данных.

### Можно ли удалить старые записи статистики?

Технически можно удалить записи через интерфейс каталога, однако это не рекомендуется без необходимости, так как:

* Статистика может использоваться для анализа трендов и планирования
* Удаление записей может нарушить целостность исторических данных
* Старые записи не влияют на производительность системы

Если необходимо освободить место в базе данных, рекомендуется использовать архивирование или экспорт данных перед удалением.

### Как интерпретировать значения полей?

**Число запросов:**

* Показывает количество HTTP-запросов к домену за период
* Высокое значение указывает на активное использование домена
* Сравнение с предыдущими периодами показывает тренды активности

**Общее время запросов:**

* Показывает суммарное время выполнения всех запросов в секундах
* Высокое значение указывает на большую нагрузку на систему
* Помогает оценить общую нагрузку на домен

**Среднее время запроса:**

* Показывает среднее время выполнения одного запроса в миллисекундах
* Высокое значение может указывать на проблемы с производительностью
* Полезно для сравнения производительности разных доменов

### Можно ли отключить сбор статистики?

Да, для отключения сбора статистики:

1. Удалите или закомментируйте переменную `ACTIVITY_REQUEST_PERIOD` в `config.env`
2. Или установите значение `0`: `ACTIVITY_REQUEST_PERIOD=0`
3. Перезапустите сервер Бипиум

После этого система не будет создавать записи в каталоге **Активность доменов**.

## Связи с другими каталогами

Каталог **Активность доменов** связан с другими системными каталогами:

* **Компании** — каталог связан с компаниями через поле **Домен**. Подробнее см. в документации по каталогу Компании

## Поддержка

Если у вас возникли вопросы или проблемы при работе с каталогом Активность доменов, обратитесь к технической поддержке Бипиум [support@bpium.ru](mailto:support@bpium.ru), предоставив:

* Версию Бипиум
* Лицензию (серийный номер)
* Описание проблемы или вопроса
* Настройки переменных окружения (без секретных данных)
* Скриншоты (если применимо)

### Дополнительные ресурсы

* [Документация по каталогу Компании](https://docs.bpium.ru/bpium-setup/systemcatalogs/sistema/kompanii)
* [Документация по каталогу Аккаунты](https://docs.bpium.ru/bpium-setup/systemcatalogs/sistema/akkaunty)
* [Документация по настройке доменов](https://docs.bpium.ru/deployment/nastroika-i-zapusk/multidomennaya-sreda)
