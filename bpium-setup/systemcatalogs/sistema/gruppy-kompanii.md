# Группы компаний

## Введение

Системный каталог **Группы компаний** используется для управления версиями компаний в серверной версии Бипиум. При обновлении сервера Бипиум (через EXE или Docker образы) обновляется только база данных сервера. Базы данных компаний обновляются отдельно, и для этого каждая компания должна быть привязана к группе компаний. Группа компаний определяет версию сервера, на которую будет обновлена база данных компании.

Каталог **Группы компаний** доступен администраторам серверной версии Бипиум и используется для управления версиями компаний в системе.

## Назначение каталога

Каталог **Группы компаний** используется для:

* **Управления версиями компаний**: установка версии сервера для компаний через группы
* **Группировки компаний**: объединение компаний в группы для удобного управления версиями
* **Планирования обновлений**: установка времени начала и окончания обновления (опционально)

## Доступ к каталогу

Каталог **Группы компаний** находится в разделе **Система** и доступен только администраторам сервера Бипиум.

**Как открыть каталог:**

1. Войдите в систему с правами администратора
2. Перейдите в раздел **Система** (в главном меню)
3. Выберите каталог **Группы компаний**

## Поля каталога

Поля в каталоге отображаются в следующем порядке:

| Поле                                           | Тип   | Описание                                                                                                  |
| ---------------------------------------------- | ----- | --------------------------------------------------------------------------------------------------------- |
| **Название**                                   | Текст | Название группы компаний для идентификации                                                                |
| **Версия на которой должна работать компания** | Связь | Связь с каталогом **Версии сервера**. Определяет версию, на которую будут обновлены все компании в группе |
| **Начало обновления**                          | Дата  | Дата и время начала обновления компаний группы (опционально)                                              |
| **Окончание обновления**                       | Дата  | Дата и время окончания обновления компаний группы (опционально)                                           |
| **Является группой по-умолчанию**              | Число | Указывает, является ли группа группой по умолчанию (опционально)                                          |

## Важная информация

### Связь с компаниями

Компании привязываются к группам через поле **Группа** в каталоге **Компании**:

* Каждая компания может быть привязана к одной группе компаний
* Версия компании определяется версией, указанной в группе компаний
* При обновлении группы все компании в группе обновляются до версии, указанной в поле **Версия на которой должна работать компания**

> **Важно:** Без привязки к группе обновление базы данных компании невозможно. Даже если у вас одна компания, для её обновления необходима группа компаний.

### Обновление компаний через группы

При обновлении сервера Бипиум (замена файлов новой сборкой и запуск `bpium-setup`) обновляется только база данных сервера. Базы данных компаний обновляются отдельно через процесс обновления компаний.

**Процесс обновления:**

1. **Обновление сервера:** выполните обновление сервера Бипиум согласно [документации по обновлению](https://docs.bpium.ru/deployment/obsluzhivanie/obnovlenie) (замена файлов новой сборкой и запуск `bpium-setup`)
2. **Настройка группы компаний:** откройте запись группы компаний в каталоге **Группы компаний** и в поле **Версия на которой должна работать компания** выберите новую версию сервера из каталога **Версии сервера**
3. **Сохранение изменений:** сохраните изменения в группе компаний
4. **Запуск обновления:** перейдите по адресу `ваш-домен/auth/updateCompanies/:groupId` (где `ваш-домен` — адрес вашего сервера, например `company.ru`, а `:groupId` — ID группы компаний) с правами администратора
5. **Автоматическое обновление:** после выполнения миграций базы данных компании поле **Текущая версия** в каталоге **Компании** автоматически обновляется версией из группы

> **Важно:**
>
> * Изменение поля **Текущая версия** в записи компании **не запускает обновление**. Это поле только отображает текущую версию после обновления
> * Для обновления базы данных компании необходимо изменить версию в группе компаний и запустить процесс обновления через роут `/auth/updateCompanies/:groupId`
> * Компания должна быть привязана к группе для возможности обновления базы данных
> * Убедитесь, что новая версия сервера установлена на сервере перед обновлением группы компаний

### Планирование обновлений

Поля **Начало обновления** и **Окончание обновления** предназначены для планирования обновлений компаний:

* **Начало обновления:** дата и время, когда планируется начать обновление компаний группы
* **Окончание обновления:** дата и время, когда планируется завершить обновление компаний группы

> **Важно:** Эти поля являются **только информационными** и не влияют на процесс обновления. Они используются для планирования и отслеживания процесса обновления, но не блокируют и не автоматизируют запуск обновления. Обновление запускается вручную через переход по адресу `/auth/updateCompanies/:groupId` независимо от значений этих полей.

### Группа по умолчанию

Поле **Является группой по-умолчанию** позволяет указать группу, которая будет использоваться по умолчанию для новых компаний. Это поле используется системой для автоматической привязки компаний к группе при их создании.

## Работа с каталогом

### Как создать группу компаний?

Для создания новой группы компаний:

1. Откройте каталог **Группы компаний**
2. Нажмите кнопку создания новой записи
3. В поле **Название** укажите название группы
4. В поле **Версия на которой должна работать компания** выберите версию сервера из каталога **Версии сервера**
5. При необходимости заполните поля **Начало обновления** и **Окончание обновления**
6. Сохраните запись

### Как обновить версию в группе?

Для обновления версии компаний в группе:

1. **Обновите сервер:** выполните обновление сервера Бипиум согласно [документации по обновлению](https://docs.bpium.ru/deployment/obsluzhivanie/obnovlenie)
2. **Настройте группу компаний:** откройте запись группы компаний в каталоге **Группы компаний** и в поле **Версия на которой должна работать компания** выберите новую версию сервера из каталога **Версии сервера**
3. **Сохраните изменения** в группе компаний
4. **Запустите обновление:** перейдите по адресу `ваш-домен/auth/updateCompanies/:groupId` (где `ваш-домен` — адрес вашего сервера, например `company.ru`, а `:groupId` — ID группы компаний) с правами администратора

> **Примечание:**
>
> * Убедитесь, что новая версия сервера установлена на сервере перед обновлением группы компаний
> * Для запуска обновления необходимо войти в систему с правами администратора и перейти по указанному адресу в браузере
> * Механизм обновления через группы работает для серверной версии и позволяет обновить базы данных компаний после обновления сервера

### Как удалить группу компаний?

Удаление группы компаний — операция, которая влияет на возможность обновления компаний, привязанных к этой группе.

**Важно:**

* **Удаление группы НЕ удаляет компании и их базы данных.** Компании остаются в системе и продолжают работать
* При удалении группы компании теряют связь с группой (поле **Группа** в каталоге **Компании** становится пустым)
* **Компании без группы не могут быть обновлены**, так как для обновления базы данных компании необходима привязка к группе
* Базы данных компаний и вся информация в них сохраняются

**Внимание:** Перед удалением группы рекомендуется:

* Привязать все компании группы к другой группе компаний
* Убедиться, что удаление не нарушит работу системы

**Как удалить группу:**

1. Откройте запись группы в каталоге **Группы компаний**
2. При необходимости привяжите все компании группы к другой группе компаний через поле **Группа** в каталоге **Компании**
3. Нажмите кнопку удаления записи
4. Подтвердите удаление

> **Примечание:** После удаления группы компании без привязки к группе не смогут обновляться до тех пор, пока не будут привязаны к новой группе.

## Связи с другими каталогами

Каталог **Группы компаний** связан с другими системными каталогами:

* **Компании** — компании привязываются к группам через поле **Группа** в каталоге **Компании**. Подробнее см. в документации по каталогу Компании
* **Версии сервера** — группы компаний используют версии сервера через поле **Версия на которой должна работать компания**. Подробнее см. в документации по каталогу Версии сервера

## Поддержка

Если у вас возникли вопросы или проблемы при работе с каталогом Группы компаний, обратитесь к технической поддержке Бипиум [support@bpium.ru](mailto:support@bpium.ru), предоставив:

* Версию Бипиум
* Лицензию (серийный номер)
* Описание проблемы или вопроса
* ID группы компаний (если применимо)
* Скриншоты (если применимо)

## Дополнительные ресурсы

* [Документация по каталогу Компании](kompanii.md)
* [Документация по каталогу Версии сервера](versii-servera.md)
* [Документация по обновлению Бипиум](https://docs.bpium.ru/deployment/obsluzhivanie/obnovlenie)
