# Приглашения

## Введение

Системный каталог **Приглашения** используется для управления приглашениями пользователей в компании Бипиум. Приглашения создаются автоматически при добавлении нового пользователя в компанию и содержат уникальную ссылку для регистрации или входа в систему.

Каталог **Приглашения** доступен администраторам серверной версии Бипиум и используется для отслеживания и управления процессом приглашения пользователей.

## Назначение каталога

Каталог **Приглашения** используется для:

* **Управления приглашениями**: отслеживание созданных приглашений пользователей
* **Регистрации новых пользователей**: приглашения содержат уникальную ссылку для регистрации в системе
* **Добавления пользователей в компании**: приглашения связывают пользователей с компаниями
* **Создания новых компаний**: приглашения могут использоваться для создания новой компании при регистрации

## Доступ к каталогу

Каталог **Приглашения** находится в разделе **Система** и доступен только администраторам сервера Бипиум.

**Как открыть каталог:**

1. Войдите в систему с правами администратора
2. Перейдите в раздел **Система** (в главном меню)
3. Выберите каталог **Приглашения**

## Поля каталога

Поля в каталоге отображаются в следующем порядке:

| Поле                          | Тип                   | Описание                                                                                                                                                                                                                                                                                                                                                     |
| ----------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **email**                     | Текст (email)         | Email-адрес приглашаемого пользователя                                                                                                                                                                                                                                                                                                                       |
| **Пригласившая компания**     | Текст                 | ID компании, которая отправила приглашение. Если поле пустое, приглашение используется для создания новой компании                                                                                                                                                                                                                                           |
| **Пригласивший пользователь** | Текст                 | ID пользователя компании, который отправил приглашение                                                                                                                                                                                                                                                                                                       |
| **Хэш ссылки**                | Текст (многострочное) | Уникальный токен (хэш) для доступа к форме регистрации или входа. Используется в ссылке приглашения                                                                                                                                                                                                                                                          |
| **Пароль**                    | Текст                 | Пароль пользователя. Отображается только если пароль был установлен администратором в каталоге **Сотрудники** (поле "Установить пароль"). Позволяет пользователю войти в систему по email и предустановленному паролю до завершения регистрации. Если пароль не установлен, поле не отображается и пользователь перенаправляется на страницу создания пароля |

## Важная информация

### Как работают приглашения?

Приглашения создаются автоматически системой в следующих случаях:

1. **При добавлении нового пользователя в компанию**:
   * Администратор компании добавляет пользователя через каталог **Пользователи**
   * Система автоматически создает запись приглашения с уникальным хэшем
   * На email пользователя отправляется письмо с ссылкой для регистрации
2. **При создании новой компании** (только если разрешено настройками):
   * Приглашение с пустым полем **Пригласившая компания** используется для создания новой компании
   * Пользователь может зарегистрироваться и создать новую компанию при регистрации
   * Если настройка `ALLOW_CREATE_COMPANY` отключена, пользователь будет перенаправлен на страницу входа
   * Настройка `ALLOW_CREATE_COMPANY` доступна для редактирования через переменную окружения в файле `config.env`. По умолчанию значение равно `USE_SUB_DOMAINS`

### Типы приглашений

Приглашения могут быть двух типов:

* **Приглашение в существующую компанию**: поле **Пригласившая компания** заполнено. Пользователь регистрируется и автоматически добавляется в указанную компанию
* **Приглашение для создания новой компании**: поле **Пригласившая компания** пустое. Пользователь может создать новую компанию при регистрации (если это разрешено настройкой `ALLOW_CREATE_COMPANY`). Если настройка отключена, пользователь будет перенаправлен на страницу входа

### Процесс регистрации по приглашению

Процесс регистрации пользователя по приглашению:

1. **Получение приглашения**: пользователь получает email с уникальной ссылкой, содержащей хэш приглашения
2. **Переход по ссылке**: пользователь переходит по ссылке, система проверяет валидность хэша
3. **Проверка аккаунта**: система проверяет, существует ли уже аккаунт с таким email
4. **Регистрация или вход**:
   * **Если приглашение с companyId** (приглашение в существующую компанию):
     * Пользователь перенаправляется на страницу установки пароля (`/setPass`)
     * После установки пароля пользователь входит в систему и добавляется в компанию
   * **Если приглашение без companyId** (приглашение для создания новой компании):
     * Если аккаунта нет — показывается форма регистрации с возможностью создать новую компанию (`newCompany`)
     * Если аккаунт существует — показывается форма для создания новой компании (используется отдельный endpoint `/auth/company/create`)
     * После регистрации/создания компании создается аккаунт (если его не было) и новая компания
     * Если флаг `newCompany` не указан и нет приглашений с `companyId`, возвращается ошибка "no company"
5. **Удаление приглашения**: после успешной регистрации, входа или создания компании все приглашения с этим email автоматически удаляются

> **Важно:** Каждое приглашение имеет уникальный хэш и может быть использовано только один раз. После использования приглашение удаляется из системы.

### Срок действия приглашений

Приглашения не имеют ограничения по сроку действия, однако:

* После использования приглашение автоматически удаляется
* Если пользователь уже зарегистрирован и добавлен в компанию, приглашение может быть удалено вручную администратором
* Рекомендуется периодически очищать неиспользованные приглашения для старых email-адресов

## Практические сценарии

### Как пригласить нового пользователя в компанию?

Приглашение пользователя в компанию выполняется через каталог **Пользователи** в компании:

1. Откройте каталог **Пользователи** в вашей компании
2. Создайте новую запись пользователя
3. В поле **Email** укажите email-адрес пользователя
4. Сохраните запись

Система автоматически:

* Создаст запись приглашения в каталоге **Приглашения**
* Сгенерирует уникальный хэш для ссылки
* Отправит email пользователю с ссылкой для регистрации

> **Примечание:** Если пользователь с таким email уже существует в системе, он будет добавлен в компанию без создания нового аккаунта. Email с приглашением будет отправлен для входа в систему.

### Как проверить статус приглашения?

Чтобы проверить статус приглашения:

1. Откройте каталог **Приглашения** в разделе **Система**
2. Найдите запись приглашения по email пользователя
3. Проверьте поля:
   * **email** — email приглашаемого пользователя
   * **Пригласившая компания** — ID компании, в которую приглашен пользователь
   * **Хэш ссылки** — уникальный токен приглашения

Если приглашение было использовано, оно автоматически удаляется из каталога.

### Что делать, если пользователь не получил приглашение?

Если пользователь не получил email с приглашением:

1. Проверьте, что запись приглашения существует в каталоге **Приглашения**
2. Проверьте правильность email-адреса в записи приглашения
3. Проверьте настройки отправки email на сервере
4. Скопируйте хэш ссылки из поля **Хэш ссылки** и отправьте пользователю ссылку вручную:
   * Формат ссылки: `https://ваш-домен/auth/register?token=ХЭШ_ПРИГЛАШЕНИЯ`
   * Или для входа: `https://ваш-домен/auth/setPass?token=ХЭШ_ПРИГЛАШЕНИЯ`

### Можно ли использовать одно приглашение несколько раз?

Нет, каждое приглашение может быть использовано только один раз:

* После успешной регистрации или входа приглашение автоматически удаляется
* Если нужно пригласить пользователя повторно, создайте новую запись пользователя в каталоге **Пользователи** компании
* Система автоматически создаст новое приглашение с новым уникальным хэшем

## Работа с каталогом

### Как создать приглашение вручную?

> **Примечание:** Обычно приглашения создаются автоматически при добавлении пользователя в компанию. Ручное создание приглашений требуется редко.

Для ручного создания приглашения (только для администраторов сервера):

1. Откройте каталог **Приглашения** в разделе **Система**
2. Нажмите кнопку создания новой записи
3. В поле **email** укажите email-адрес приглашаемого пользователя
4. В поле **Пригласившая компания** укажите ID компании (или оставьте пустым для создания новой компании)
5. В поле **Пригласивший пользователь** укажите ID пользователя, который отправляет приглашение
6. В поле **Хэш ссылки** укажите уникальный хэш (можно сгенерировать через API или оставить пустым для автоматической генерации)
7. Сохраните запись

> **Важно:** После создания приглашения необходимо вручную отправить email пользователю с ссылкой, содержащей хэш из поля **Хэш ссылки**. Формат ссылки: `https://ваш-домен/auth/register?token=ХЭШ`

### Как удалить приглашение?

Удаление приглашения может потребоваться, если:

* Приглашение было отправлено по ошибке
* Пользователь больше не нужен в компании
* Приглашение устарело и не используется

**Как удалить приглашение:**

1. Откройте каталог **Приглашения** в разделе **Система**
2. Найдите запись приглашения
3. Нажмите кнопку удаления записи
4. Подтвердите удаление

> **Примечание:** После удаления приглашения пользователь не сможет использовать ссылку для регистрации. Если пользователь уже зарегистрирован, удаление приглашения не повлияет на его доступ к компании.

## Технические детали

### Структура данных приглашения

Приглашение в системе представлено следующими данными:

* **email** — email-адрес приглашаемого пользователя
* **companyId** — ID компании, которая отправила приглашение (может быть пустым)
* **companyUserId** — ID пользователя компании, который отправил приглашение
* **hash** — уникальный токен для доступа к форме регистрации
* **password** — пароль пользователя, заполняется автоматически при установке пароля в каталоге **Сотрудники** (поле "Установить пароль"). Позволяет пользователю войти по email и предустановленному паролю до завершения регистрации.

### Генерация хэша приглашения

Хэш приглашения генерируется автоматически системой при создании приглашения:

* Хэш имеет фиксированную длину
* Хэш генерируется криптографически стойким способом
* Каждый хэш уникален и не может быть повторно использован

### API для работы с приглашениями

Система предоставляет API для работы с приглашениями:

* **Получение приглашения по хэшу**: используется при переходе по ссылке приглашения
* **Получение приглашений по email**: используется для проверки существующих приглашений
* **Создание приглашения**: используется при добавлении пользователя в компанию
* **Удаление приглашения**: выполняется автоматически после использования

## Связи с другими каталогами

Каталог **Приглашения** связан с другими системными каталогами:

* **Аккаунты** — при регистрации по приглашению создается запись в каталоге **Аккаунты**. Подробнее см. в документации по каталогу Аккаунты
* **Компании** — приглашения связаны с компаниями через поле **Пригласившая компания**. Подробнее см. в документации по каталогу Компании
* **Пользователи** — при использовании приглашения создается запись пользователя в каталоге **Пользователи** компании

## Часто задаваемые вопросы

### Почему приглашение не отправляется пользователю?

Если email с приглашением не отправляется, проверьте:

1. **Настройки отправки email**: убедитесь, что на сервере настроена отправка email
2. **Правильность email-адреса**: проверьте, что email указан правильно в записи приглашения
3. **Логи сервера**: проверьте логи сервера на наличие ошибок отправки email
4. **Спам-фильтры**: убедитесь, что письмо не попало в спам

### Можно ли изменить email в приглашении?

Технически можно изменить email в записи приглашения, однако это не рекомендуется:

* Если приглашение уже отправлено, изменение email не отправит новое письмо
* Лучше удалить старое приглашение и создать новое с правильным email через добавление пользователя в компанию

### Что происходит, если пользователь уже зарегистрирован?

Если пользователь с указанным email уже зарегистрирован в системе:

* При использовании приглашения пользователь автоматически добавляется в компанию (если еще не был добавлен)
* Отправляется email с ссылкой для входа в систему вместо регистрации
* После входа приглашение удаляется

### Можно ли использовать приглашение для нескольких пользователей?

Нет, каждое приглашение привязано к конкретному email-адресу:

* Хэш приглашения уникален и связан с email
* Одно приглашение может быть использовано только одним пользователем
* Для приглашения нескольких пользователей создайте отдельные записи пользователей в компании

### Как проверить, использовано ли приглашение?

Если приглашение было использовано:

* Запись приглашения автоматически удаляется из каталога
* Если запись приглашения отсутствует в каталоге, значит оно было использовано или удалено
* Проверьте каталог **Аккаунты** и **Пользователи** компании, чтобы убедиться, что пользователь зарегистрирован

## Поддержка

Если у вас возникли вопросы или проблемы при работе с каталогом Приглашения, обратитесь к технической поддержке Бипиум [support@bpium.ru](mailto:support@bpium.ru), предоставив:

* Версию Бипиум
* Лицензию (серийный номер)
* Описание проблемы или вопроса
* Email приглашаемого пользователя (если применимо)
* Хэш приглашения (если применимо)
* Скриншоты (если применимо)

## Дополнительные ресурсы

* [Документация по каталогу Аккаунты](akkaunty.md)
* [Документация по каталогу Компании](kompanii.md)
