# Шаблоны писем

## Введение

Системный каталог **Шаблоны писем** используется для управления шаблонами электронных писем, которые отправляются системой Бипиум. Шаблоны позволяют настраивать содержание, тему и отправителя писем, используя плейсхолдеры для подстановки динамических данных.

Каталог **Шаблоны писем** доступен администраторам серверной версии Бипиум и используется для настройки внешнего вида и содержания автоматически отправляемых системных писем.

> **Важно:** Плейсхолдеры — это подстановочные выражения в формате `{{переменная}}`, которые заменяются на реальные данные при отправке письма. Плейсхолдеры позволяют создавать персонализированные письма с динамическим содержимым.

## Назначение каталога

Каталог **Шаблоны писем** используется для:

* **Настройки системных писем**: управление шаблонами писем, отправляемых системой автоматически
* **Персонализации писем**: использование плейсхолдеров для подстановки динамических данных (имя пользователя, ссылки, данные компании и т.д.)
* **Брендинга**: настройка внешнего вида писем в соответствии с корпоративным стилем
* **Многоязычности**: возможность создания шаблонов для разных языков и сценариев
* **Использования в сценариях**: создание шаблонов для использования в бизнес-процессах и сценариях, где плейсхолдеры позволяют подставлять данные из процесса (значения полей записей, результаты вычислений и т.д.)

## Доступ к каталогу

Каталог **Шаблоны писем** находится в разделе **Система** и доступен только администраторам сервера Бипиум.

**Как открыть каталог:**

1. Войдите в систему с правами администратора
2. Перейдите в раздел **Система** (в главном меню)
3. Выберите каталог **Шаблоны писем**

## Поля каталога

Поля в каталоге отображаются в следующем порядке:

| Поле                          | Тип                   | Описание                                                                                                                 |
| ----------------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| **Название**                  | Текст                 | Название шаблона письма для удобной идентификации                                                                        |
| **Шаблон письма**             | Текст (многострочное) | HTML-шаблон содержимого письма. Поддерживает плейсхолдеры в формате `{{переменная}}` для подстановки динамических данных |
| **Тема письма**               | Текст (многострочное) | Тема письма. Также поддерживает плейсхолдеры для динамической подстановки данных                                         |
| **От чьего имени отправлять** | Текст (многострочное) | Имя отправителя письма. Поддерживает плейсхолдеры. Фактический email отправителя берется из настроек сервера             |
| **ID шаблона**                | Текст                 | Уникальный идентификатор шаблона, используемый системой для выбора нужного шаблона при отправке письма                   |

## Важная информация

### Как работают шаблоны писем?

Шаблоны писем используются системой автоматически при отправке различных типов писем:

1. **При создании приглашения пользователя в компанию**: используется шаблон с ID `invite-from-company-for-new` или `invite-from-company-for-registered`
2. **При регистрации нового пользователя**: используется шаблон с ID `invite-to-register`
3. **При завершении регистрации**: используется шаблон с ID `register-complete`
4. **При сбросе пароля**: используется шаблон с ID `reset-password`

Система автоматически выбирает нужный шаблон по его ID и подставляет данные в плейсхолдеры перед отправкой письма.

### Плейсхолдеры в шаблонах

Шаблоны используют синтаксис **Handlebars** для подстановки динамических данных. Плейсхолдеры записываются в формате `{{переменная}}` или `{{объект.свойство}}`.

#### Доступные плейсхолдеры

**Системные переменные VENDOR**

Переменная `VENDOR` содержит информацию о системе и всегда доступна во всех шаблонах:

* `{{VENDOR.title}}` — название системы (например, "Бипиум")
* `{{VENDOR.siteUrl}}` — URL сайта системы
* `{{VENDOR.site}}` — домен сайта системы

**Пример использования:**

```
Тема: Приглашение на корпоративный портал {{VENDOR.title}}
Содержимое: © {{VENDOR.title}}, <a href="{{VENDOR.siteUrl}}">{{VENDOR.site}}</a>
```

**Переменные для приглашений**

Для шаблонов приглашений доступны следующие переменные:

* `{{inviter}}` — имя пользователя, который отправил приглашение
* `{{inviteUser}}` — дополнительная информация о приглашающем пользователе
* `{{inviteEmail}}` — email-адрес приглашаемого пользователя
* `{{companyLink}}` — ссылка на компанию (домен компании)
* `{{loginLink}}` — полная ссылка для входа в систему (включает токен приглашения)
* `{{registerLink}}` — полная ссылка для регистрации (включает токен приглашения)

**Пример использования:**

```
Тема: Приглашение на корпоративный портал {{VENDOR.title}}
От: {{inviter}}
Содержимое: 
  Добрый день!
  Приглашаю вас на корпоративный портал нашей компании в системе {{VENDOR.title}}.
  Ваш логин: {{inviteEmail}}
  <a href="http://{{loginLink}}">Войти в систему</a>
```

**Переменные для сброса пароля**

Для шаблона сброса пароля доступны:

* `{{resetLink}}` — полная ссылка для сброса пароля (включает токен)
* `{{userName}}` — имя пользователя (может быть пустым)
* `{{companyLink}}` — ссылка на компанию

**Пример использования:**

```
Содержимое:
  {{#if userName}}
    {{userName}}, мы получили запрос на смену вашего пароля.
  {{else}}
    Мы получили запрос на смену вашего пароля.
  {{/if}}
  <a href="http://{{resetLink}}">Смена пароля</a>
```

#### Условные конструкции

Шаблоны поддерживают условные конструкции Handlebars:

* `{{#if переменная}}...{{else}}...{{/if}}` — условное отображение блока в зависимости от наличия переменной

**Пример:**

```html
{{#if userName}}
  Здравствуйте, {{userName}}!
{{else}}
  Здравствуйте!
{{/if}}
```

### Предустановленные шаблоны

При установке системы автоматически создаются следующие шаблоны:

#### 1. Приглашение в компанию (для зарегистрированных пользователей)

* **ID шаблона**: `invite-from-company-for-registered`
* **Название**: "Приглашение в компанию"
* **Используется**: когда приглашается пользователь, который уже зарегистрирован в системе
* **Плейсхолдеры**: `{{inviter}}`, `{{inviteEmail}}`, `{{companyLink}}`, `{{loginLink}}`, `{{VENDOR.title}}`, `{{VENDOR.siteUrl}}`, `{{VENDOR.site}}`

#### 2. Приглашение в компанию (для новых пользователей)

* **ID шаблона**: `invite-from-company-for-new`
* **Название**: "Приглашение в компанию"
* **Используется**: когда приглашается новый пользователь, который еще не зарегистрирован в системе
* **Плейсхолдеры**: `{{inviter}}`, `{{inviteEmail}}`, `{{companyLink}}`, `{{loginLink}}`, `{{VENDOR.title}}`, `{{VENDOR.siteUrl}}`, `{{VENDOR.site}}`

#### 3. Регистрация в системе

* **ID шаблона**: `invite-to-register`
* **Название**: "Регистрация в системе"
* **Используется**: для приглашения на регистрацию новой компании
* **Плейсхолдеры**: `{{companyLink}}`, `{{registerLink}}`, `{{VENDOR.title}}`, `{{VENDOR.siteUrl}}`, `{{VENDOR.site}}`

#### 4. Регистрация завершена

* **ID шаблона**: `register-complete`
* **Название**: "Регистрация завершена"
* **Используется**: после успешной регистрации пользователя
* **Плейсхолдеры**: `{{inviteEmail}}`, `{{companyLink}}`, `{{VENDOR.title}}`, `{{VENDOR.siteUrl}}`, `{{VENDOR.site}}`

#### 5. Сброс пароля

* **ID шаблона**: `reset-password`
* **Название**: "Сброс пароля"
* **Используется**: при запросе сброса пароля пользователем
* **Плейсхолдеры**: `{{resetLink}}`, `{{userName}}`, `{{companyLink}}`, `{{VENDOR.title}}`, `{{VENDOR.siteUrl}}`, `{{VENDOR.site}}`

## Практические сценарии

### Как изменить шаблон письма?

Для изменения существующего шаблона:

1. Откройте каталог **Шаблоны писем** в разделе **Система**
2. Найдите нужный шаблон по названию или ID шаблона
3. Откройте запись шаблона для редактирования
4. Измените поля:
   * **Тема письма** — для изменения темы письма
   * **Шаблон письма** — для изменения содержимого письма (HTML)
   * **От чьего имени отправлять** — для изменения имени отправителя
5. Сохраните изменения

> **Важно:** При изменении шаблона убедитесь, что все используемые плейсхолдеры будут доступны при отправке письма. Неправильное использование плейсхолдеров может привести к отображению пустых значений или ошибкам.

### Как создать новый шаблон письма?

Для создания нового шаблона:

1. Откройте каталог **Шаблоны писем** в разделе **Система**
2. Создайте новую запись
3. Заполните поля:
   * **Название** — укажите понятное название шаблона
   * **ID шаблона** — укажите уникальный идентификатор (например, `custom-template-1`)
   * **Тема письма** — укажите тему письма с плейсхолдерами при необходимости
   * **Шаблон письма** — создайте HTML-шаблон с плейсхолдерами
   * **От чьего имени отправлять** — укажите имя отправителя
4. Сохраните запись

#### Использование шаблонов в сценариях

Шаблоны писем можно создавать для использования в бизнес-процессах и сценариях. В этом случае плейсхолдеры особенно важны, так как позволяют:

* Подставлять данные из записей каталогов (значения полей, названия записей и т.д.)
* Использовать результаты вычислений и формул из сценария
* Динамически формировать содержимое письма в зависимости от контекста процесса
* Персонализировать письма для каждого получателя на основе данных процесса

**Пример использования в сценарии:**

При создании шаблона для сценария можно использовать плейсхолдеры для подстановки данных из процесса:

```html
<h1>Уведомление о задаче</h1>
<p>Здравствуйте, {{userName}}!</p>
<p>Вам назначена задача: {{taskName}}</p>
<p>Срок выполнения: {{deadline}}</p>
<p>Описание: {{taskDescription}}</p>
```

При вызове шаблона в сценарии все плейсхолдеры будут заменены на реальные значения из данных процесса.

### Как использовать плейсхолдеры в шаблоне?

Плейсхолдеры используются для подстановки динамических данных в шаблон. Примеры:

**В теме письма:**

```
Приглашение на корпоративный портал {{VENDOR.title}}
```

**В содержимом письма:**

```html
<h1>Добрый день, {{userName}}!</h1>
<p>Ваш логин: {{inviteEmail}}</p>
<p>Ссылка для входа: <a href="http://{{loginLink}}">Войти в систему</a></p>
```

**В имени отправителя:**

```
{{inviter}}
```

## Работа с каталогом

### Как редактировать HTML-шаблон?

HTML-шаблон письма можно редактировать напрямую в поле **Шаблон письма**:

1. Откройте запись шаблона
2. Перейдите в поле **Шаблон письма**
3. Отредактируйте HTML-код, используя плейсхолдеры для динамических данных
4. Сохраните изменения

> **Совет:** Для удобства редактирования HTML-шаблонов можно использовать внешний редактор, а затем скопировать код в поле шаблона.

### Как проверить шаблон перед использованием?

Для проверки шаблона:

1. Убедитесь, что все используемые плейсхолдеры будут доступны при отправке
2. Проверьте HTML-разметку на корректность
3. Убедитесь, что ID шаблона уникален и соответствует ожиданиям системы
4. После сохранения шаблон будет использоваться при следующей отправке письма соответствующего типа

> **Примечание:** Система не предоставляет функцию предварительного просмотра шаблона с подставленными данными. Для проверки можно временно изменить ID шаблона и протестировать отправку письма.

### Как удалить шаблон?

Удаление шаблона может потребоваться, если:

* Шаблон больше не используется
* Нужно заменить шаблон новым
* Шаблон был создан по ошибке

**Как удалить шаблон:**

1. Откройте каталог **Шаблоны писем** в разделе **Система**
2. Найдите запись шаблона
3. Нажмите кнопку удаления записи
4. Подтвердите удаление

> **Важно:** Удаление предустановленных шаблонов (с ID `invite-from-company-for-registered`, `invite-from-company-for-new`, `invite-to-register`, `register-complete`, `reset-password`) может привести к ошибкам при отправке соответствующих писем. Рекомендуется не удалять предустановленные шаблоны, а редактировать их при необходимости.

## Технические детали

### Структура данных шаблона

Шаблон письма в системе представлен следующими данными:

* **name** — название шаблона
* **template-code** — уникальный идентификатор шаблона
* **template** — HTML-содержимое шаблона письма
* **subject** — тема письма
* **from** — имя отправителя

### Обработка плейсхолдеров

Система использует библиотеку **Handlebars** для обработки плейсхолдеров:

* Плейсхолдеры обрабатываются при отправке письма
* Все данные передаются в шаблон как объект JavaScript
* Переменная `VENDOR` автоматически добавляется ко всем шаблонам
* Несуществующие переменные заменяются пустой строкой

## Связи с другими каталогами

Каталог **Шаблоны писем** связан с другими системными каталогами:

* **Приглашения** — шаблоны используются при отправке писем с приглашениями. Подробнее см. в документации по каталогу Приглашения
* **Аккаунты** — шаблоны используются при отправке писем, связанных с аккаунтами пользователей. Подробнее см. в документации по каталогу Аккаунты
* **Компании** — шаблоны используют данные компаний (ссылки, логотипы) при формировании писем. Подробнее см. в документации по каталогу Компании

## Часто задаваемые вопросы

### Почему плейсхолдеры не подставляются в письме?

Если плейсхолдеры не подставляются, проверьте:

1. **Правильность синтаксиса**: убедитесь, что плейсхолдер записан в формате `{{переменная}}` (с двойными фигурными скобками)
2. **Доступность переменной**: убедитесь, что переменная передается в метод `sendEmailByTemplate()` в объекте `data`
3. **Регистр символов**: имена переменных чувствительны к регистру (`{{userName}}` и `{{username}}` — разные переменные)
4. **Вложенные свойства**: для доступа к свойствам объекта используйте точку: `{{VENDOR.title}}`

### Можно ли использовать HTML в шаблоне?

Да, шаблоны поддерживают полный HTML:

* Можно использовать любые HTML-теги
* Можно использовать CSS-стили (inline или в теге `<style>`)
* Можно использовать изображения (через URL или плейсхолдеры)
* Рекомендуется использовать inline-стили для лучшей совместимости с email-клиентами

### Как добавить изображение в шаблон?

Изображения можно добавить несколькими способами:

1. **Через URL**: `<img src="http://example.com/image.png" alt="Описание">`
2. **Через плейсхолдер**: `<img src="http://{{companyLink}}/logo/emblem" alt="Логотип">`
3. **Через base64**: `<img src="data:image/png;base64,..." alt="Изображение">`

> **Примечание:** Использование плейсхолдеров для URL изображений позволяет динамически подставлять ссылки на логотипы компаний или другие изображения.

### Можно ли создать несколько шаблонов для одного типа писем?

Технически можно создать несколько шаблонов с разными ID, но система использует только один шаблон для каждого типа письма (определяется по ID шаблона). Для использования разных шаблонов для одного типа писем необходимо:

1. Создать шаблоны с разными ID
2. Модифицировать код системы для выбора нужного шаблона в зависимости от условий
3. Или использовать условные конструкции внутри одного шаблона

### Как изменить стиль писем?

Стиль писем можно изменить, редактируя HTML-шаблон:

1. Измените CSS-стили в теге `<style>` или используйте inline-стили
2. Измените цвета, шрифты, размеры элементов
3. Измените структуру HTML для изменения расположения элементов

> **Совет:** Для лучшей совместимости с email-клиентами рекомендуется использовать inline-стили и табличную верстку.

### Что делать, если письмо не отправляется?

Если письмо не отправляется, проверьте:

1. **Настройки email на сервере**: убедитесь, что настроены `EMAIL_LOGIN`, `EMAIL_PASSWORD`, `EMAIL_HOST` и другие параметры
2. **Правильность ID шаблона**: убедитесь, что ID шаблона указан правильно в коде
3. **Логи сервера**: проверьте логи сервера на наличие ошибок
4. **Существование шаблона**: убедитесь, что шаблон с указанным ID существует в каталоге

## Поддержка

Если у вас возникли вопросы или проблемы при работе с каталогом Шаблоны писем, обратитесь к технической поддержке Бипиум [support@bpium.ru](mailto:support@bpium.ru), предоставив:

* Версию Бипиум
* Лицензию (серийный номер)
* Описание проблемы или вопроса
* Скриншоты шаблона или ошибки

## Дополнительные ресурсы

* [Документация по каталогу Приглашения](priglasheniya.md)
* [Документация по каталогу Аккаунты](akkaunty.md)
* [Документация по каталогу Компании](kompanii.md)
* [Документация Handlebars](https://handlebarsjs.com/) — для подробной информации о синтаксисе шаблонов
