# Для Bpium

## Настройка конфигурационного файла (config.env)

Bpium использует переменные окружения для хранения настроек. Если переменные окружения не заданы, то Bpium считывает их из файла `config.env` из папки приложения. \
Не указывайте в нём параметры, если их значения совпадают со значениями по умолчанию.&#x20;

### Системные настройки

|                                                                                      |          |                                                                                                                                                                                                                                                                                                                                                              |
| ------------------------------------------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`DB_CONNECTION_STRING`**`(обязательный)`                                           | `string` | <p>Строка подключения к базе данных Бипиума. <br>Формат: <code>postgres://</code><em><code>логин</code></em><code>:</code><em><code>пароль</code></em><code>@</code><em><code>адрес</code></em><code>:</code><em><code>порт</code></em><code>/</code><em><code>бд</code></em></p><p>Пример:<code>postgres://user:password@localhost:5432/bpium_db</code></p> |
| <p><strong><code>SERIAL_NUMBER</code></strong></p><p><code>(обязательный)</code></p> | `string` | <p>Серийный номер продукта для активации.</p><p>При его отсутствии будет доступна только одна учетная запись администратора.</p>                                                                                                                                                                                                                             |
| `PUBLIC_WWW_DIR`                                                                     | `string` | <p>Относительный путь к директории публичных файлов. Используется для хранения дополнительных модулей.</p><p>По умолчанию: <code>www</code>.</p>                                                                                                                                                                                                             |

### Безопасность

|                                                                                       |          |                                                                                                                                                   |
| ------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><strong><code>COOKIE_SECRET</code></strong> </p><p><code>(обязательный)</code></p> | `string` | <p>Уникальная строка, используется для шифрования авторизованных сессий сотрудников.</p><p>Придумайте строку.</p>                                 |
| **`SCRIPTS_TOKEN_SECRET`**`(обязательный)`                                            | `string` | Уникальная строка, используется для формирования кода доступа к API без авторизации. Такой доступ использует сервер процессов. Придумайте строку. |

### **Сетевые настройки и защищенный канал связи.**&#x20;

Для работы приложения и модуля телефонии

|                            |          |                                                                                                                                                                                                                                                                                                                                   |
| -------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `HOST`                     | `string` | <p>Адрес (домен) сервера для доступа из внешних ресурсов. Например, писем с приглашениями на регистрацию. <br>Формат: <code>domen.ru</code> или <code>213.48.87.211</code></p>                                                                                                                                                    |
| `PORT_HTTP`                | `int`    | <p>Порт веб-сервера Bpium для HTTP.</p><p>Если пуст, то сервер не принимает запросы по HTTP.</p><p>По умолчанию: <code>80</code>.</p>                                                                                                                                                                                             |
| `PORT_HTTPS`               | `int`    | <p>Порт веб-сервера Bpium для HTTPS.</p><p>Используется для безопасного соединения при установленном флаге <code>HTTPS</code>. По умолчанию: <code>443</code>.</p>                                                                                                                                                                |
| `HTTPS`                    | `bool`   | <p>Использовать протокол HTTPS.</p><p>Значения: <code>true</code>/<code>false</code>. По умолчанию: <code>false</code>. </p>                                                                                                                                                                                                      |
| `HTTPS_FORCE`              | `bool`   | <p>Включить редирект с <code>PORT_HTTP</code> на <code>PORT_HTTPS</code>.<br>Значения: <code>true</code>/<code>false</code>. По умолчанию: = <code>HTTPS</code>. </p>                                                                                                                                                             |
| `REDIRECT_CLIENT_TO_HTTPS` | `bool`   | <p>Включить редирект с PORT_HTTP на PORT_HTTPS<br>для выдачи приложения (при этом API продолжит работать без редиректа). Используется для принудительного переключения на HTTPS и для конфигурации, когда приложение стоит за веб-сервером обеспечивающим работу по HTTPS.<br>Значения: <code>true</code>/<code>false</code>.</p> |
| `HTTPS_CERTIFICATE_PATH`   | `string` | Путь к файлу сертификата (crt).                                                                                                                                                                                                                                                                                                   |
| `HTTPS_KEY_PATH`           | `string` | Путь к файлу с ключом сертификата (key).                                                                                                                                                                                                                                                                                          |

### **Настройка почтовой службы.**&#x20;

Для опциональной отправки приглашений сотрудникам на почту.

|                  |          |                                                                                                                                                                        |
| ---------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `EMAIL_SERVICE`  | `string` | <p>SMTP-сервис. Допустим один из указанных:<br><a href="https://github.com/nodemailer/nodemailer-wellknown">https://github.com/nodemailer/nodemailer-wellknown</a></p> |
| `EMAIL_LOGIN`    | `string` | Адрес эл. почты для авторизации по SMTP                                                                                                                                |
| `EMAIL_PASSWORD` | `string` | Пароль от эл. почты                                                                                                                                                    |

### **Настройка авторизации**

Настройки для проверки пароля через сторонние сервисы, например Active Directory.

|                          |          |                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `AUTH_TYPE`              | `string` | Тип авторизации: `local` — через Бипиум, `ldap` — через Active Directory. По умолчанию: `local`.                                                                                                                                                                                                                                                                                                                                                             |
| `AUTH_LDAP_URL`          | `string` | <p>URL-сервера. Пример: <code>ldap://192.168.0.100</code></p><p><a href="https://github.com/vesse/node-ldapauth-fork#ldapauth-config-options">Подробнее о параметрах</a></p>                                                                                                                                                                                                                                                                                 |
| `AUTH_LDAP_BINDDN`       | `string` | <p>Соединение к DN под администратором.</p><p>Пример: <code>CN=bpiumauth,CN=Users,DC=bpium</code></p>                                                                                                                                                                                                                                                                                                                                                        |
| `AUTH_LDAP_PASSWORD`     | `string` | Пароль доступа к `AUTH_LDAP_BINDDN`                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `AUTH_LDAP_SEARCHBASE`   | `string` | <p>Базовый DN, в котором искать пользователей.<br>Пример: <code>CN=users,DC=bpium</code></p>                                                                                                                                                                                                                                                                                                                                                                 |
| `AUTH_LDAP_SEARCHFIELD`  | `string` | <p>Поле пользователя AD, в котором содержится логин.</p><p>По умолчанию: <code>cn</code>.</p>                                                                                                                                                                                                                                                                                                                                                                |
| `AUTH_LDAP_SEARCHFILTER` | `string` | <p>Фильтр для поиска пользователя.<br>По умолчанию: <code>{{username}}</code>.</p>                                                                                                                                                                                                                                                                                                                                                                           |
| `AUTH_LDAP_SESSION_AGE`  | `int`    | <p>Время жизни авторизационной сессии с AD.</p><p>Проверка пароля через LDAP операция долгая. Если проверять пароль каждый раз, это замедлит работу сотрудника. Поэтому Бипиум запоминает авторизацию на некое время и периодически перепроверяет её валидность. Если пользователя удалили в AD или изменили пароль, то он продолжит работать в Бипиуме в течение этого времени. Задается в миллисекундах.<br>По умолчанию: <code>300000</code>. (5 мин)</p> |

### **Настройка файлового сервера**

Настройки для доступа на сервер Amazon S3 или локальный сервер-хранилище Bpium S3.

|                                 |          |                                                                                                                                                                                                                          |
| ------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `S3_LOCAL`                      | `bool`   | <p>Использовать локальное хранилище или Amazon.<br><code>true</code> — локальное, <code>false</code> — Amazon.</p><p>По умолчанию: <code>true</code>.</p>                                                                |
| **`S3_HOST`**`(обязательный)`   | `string` | <p>Публичный (локальный) адрес хранилища, доступный с компьютеров сотрудников (localhost не допустим).</p><p>Пример: <code>files.company.ru</code> или <code>211.129.48.11</code>.</p><p>Для Amazon формируется сам.</p> |
| `S3_PORT`                       | `int`    | <p>Порт локального хранилища. По умолчанию: <code>2020</code>.<br>Для Amazon формируется сам.</p>                                                                                                                        |
| `S3_REGION`                     | `string` | <p>Регион дата-центра Amazon.<br>Не используется для локального хранилища.</p>                                                                                                                                           |
| `S3_BUCKET`                     | `string` | Идентификатор хранилища. По умолчанию: `storage`.                                                                                                                                                                        |
| **`S3_KEY`**`(обязательный)`    | `string` | <p>Публичный ключ доступа.</p><p>Для Amazon предоставляется Amazon.</p><p>Для локального хранилища — придумайте строку.</p>                                                                                              |
| **`S3_SECRET`**`(обязательный)` | `string` | <p>Секретный код доступа.</p><p>Для Amazon предоставляется Amazon.</p><p>Для локального хранилища — придумайте строку.</p>                                                                                               |
| `S3_HTTPS`                      | `bool`   | <p>Использовать SSL-сертификаты и протокол HTTPS.<br>Значения: <code>true</code>/<code>false</code>. По умолчанию: <code>false</code>. </p>                                                                              |

### **Настройка сервера процессов**

Настройка для запуска на исполнение процессов через сервер Bpium BPM.

|              |          |                                                                                                                                             |
| ------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `BPM_HOST`   | `string` | <p>Публичный/локальный адрес сервера.</p><p>Пример: <code>bpm.company.ru</code> или <code>211.129.48.11</code>.</p>                         |
| `BPM_PORT`   | `int`    | Порт сервера процессов. По умолчанию: `2030`.                                                                                               |
| `BPM_SECRET` | `string` | <p>Секретный код доступа.</p><p>Придумайте уникальную строку.</p>                                                                           |
| `BPM_HTTPS`  | `bool`   | <p>Использовать SSL-сертификаты и протокол HTTPS.<br>Значения: <code>true</code>/<code>false</code>. По умолчанию: <code>false</code>. </p> |

### **Лимитирование запросов к API**

Для предотвращения перегрузки сервера

|                               |       |                                                                                                                    |
| ----------------------------- | ----- | ------------------------------------------------------------------------------------------------------------------ |
| `LIMIT_USER_REQUEST_DURATION` | `int` | <p>Интервал оценки числа запросов от одного аккаунта.</p><p>В миллисекундах. По умолчанию: <code>30000</code>.</p> |
| `LIMIT_USER_MAX_REQUESTS`     | `int` | Макс. число запросов от одного аккаунта за интервал. По умолчанию: `100`.                                          |
| `LIMIT_IP_REQUEST_DURATION`   | `int` | <p>Интервал оценки числа запросов с одного IP-адреса.</p><p>В миллисекундах. По умолчанию: <code>30000</code>.</p> |
| `LIMIT_IP_MAX_REQUESTS`       | `int` | Макс. число запросов с одного IP-адреса за интервал. По умолчанию: `1000`.                                         |

### **Лимитирование запросов авторизации**

Для предотвращения перебора паролей

|                                 |       |                                                                                                                                                                                                                                    |
| ------------------------------- | ----- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `LOGIN_LIMIT_MAX_AUTH_INTERVAL` | `int` | <p>Каждая неудачная попытка авторизации логарифмически увеличивает время до разрешенной следующей попытки.</p><p>Макс. время блокировки попыток авторизации.</p><p>В миллисекундах. По умолчанию: <code>300000</code>. (5 мин)</p> |
| `LOGIN_LIMIT_MAX_AUTH_ATTEMPTS` | `int` | Макс. число неудачных попыток авторизации под одним логином. По умолчанию: `Infinity`. (бесконечно)                                                                                                                                |

### **Кеш**

|                           |       |                                                                                                                                                                                                                |
| ------------------------- | ----- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `COMPANY_CACHE_LIFE_TIME` | `int` | <p>Бипиум кеширует служебные данные для увеличения производительности. Параметр определяет время жизни данных в кеше (в мс). <code>0</code> — не использовать.</p><p>По умолчанию: не задан (бесконечно). </p> |

### **Лайфхаки**

{% hint style="warning" %}
Любую переменную окружения можно передать с префиксом BPIUM\_ или без префикса. Если указаны оба, то приоритет за тем что с префиксом. Примеры:

Без префикса:

```
PARAMETER_NAME_STRING=string_value
```

С префиксом:

```
BPIUM_PARAMETER_NAME_STRING=string_value
```
{% endhint %}

|                                |       |                                                                                                                                           |
| ------------------------------ | ----- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `NODE_TLS_REJECT_UNAUTHORIZED` | `int` | Параметр позволяет Бипиуму отправлять запросы (вебхуки) к системе с самоподписным сертификатом. Не безопасно! Для активации укажите: `0`. |
